!function(a){var b;if("function"==typeof define&&define.amd)define(["leaflet"],a);else if("object"==typeof module&&"object"==typeof module.exports)b=require("leaflet"),module.exports=a(b);else{if("undefined"==typeof window.L)throw"Leaflet must be loaded first";a(window.L)}}(function(a){return a.Playback=a.Playback||{},a.Playback.Util=a.Class.extend({statics:{DateStr:function(a){return new Date(1e3*(a-15768e6)).toDateString()},TimeStr:function(a){var b=new Date(1e3*(a-15768e6)),c=b.getHours(),d=b.getMinutes(),e=b.getSeconds(),f=a/1e3,g=(f-Math.floor(f)).toFixed(2).slice(1),h="AM";return c>11&&(c%=12,h="PM"),0===c&&(c=12),10>d&&(d="0"+d),10>e&&(e="0"+e),c+":"+d+":"+e+g+" "+h},SeasonStr:function(a){var b=new Date(1e3*(a-15768e6)),c=b.getMonth(),d="";return(c>=12||2>=c)&&(d="Winter"),c>=3&&5>=c&&(d="Spring"),c>=6&&8>=c&&(d="Summer"),c>=9&&11>=c&&(d="Autumn"),d},YearStr:function(a){var b=new Date(1e3*(a-15768e6)),c=b.getFullYear();return c},ParseGPX:function(a){for(var b={type:"Feature",geometry:{type:"MultiPoint",coordinates:[]},properties:{time:[],speed:[],altitude:[]},bbox:[]},c=$.parseXML(a),d=$(c).find("trkpt"),e=0,f=d.length;f>e;e++){var g=d[e],h=parseFloat(g.getAttribute("lat")),i=parseFloat(g.getAttribute("lon")),j=$(g).find("time").text(),k=$(g).find("ele").text(),l=new Date(j).getTime(),m=parseFloat(k),n=b.geometry.coordinates,o=b.properties,p=o.time,q=b.properties.altitude;n.push([i,h]),p.push(l),q.push(m)}return b}}}),a.Playback=a.Playback||{},a.Playback.MoveableMarker=a.Marker.extend({initialize:function(b,c,d){var e=c.marker||{};this._feature=d,jQuery.isFunction(e)&&(e=e(d)),a.Marker.prototype.initialize.call(this,b,e),this.popupContent="",this.popupContent=d.voyagedetails.first_ship_name,e.getPopup&&(this.popupContent=e.getPopup(d)),this.bindPopup(this.getPopupContent())},getPopupContent:function(){return""!==this.popupContent?"<b>"+this.popupContent+"</b><br/>":""},move:function(b,c){a.DomUtil.TRANSITION&&(this._icon&&(this._icon.style[a.DomUtil.TRANSITION]="all "+c+"ms linear",this._popup&&this._popup._wrapper&&(this._popup._wrapper.style[a.DomUtil.TRANSITION]="all "+c+"ms linear")),this._shadow&&(this._shadow.style[a.DomUtil.TRANSITION]="all "+c+"ms linear")),this.setLatLng(b)}}),a.Playback=a.Playback||{},a.Playback.Track=a.Class.extend({initialize:function(a,b,c){c=c||{};var d=c.tickLen||250;this._geoJSON=b,this._tickLen=d,this._ticks=[],this._marker=null,this._map=a;var e,f,g=b.properties.time,h=b.geometry.coordinates,i=h[0],j=h[1],k=g[0],l=k,m=g[1],n=l%d;if(1===g.length)return 0!==n&&(l+=d-n),this._ticks[l]=h[0],this._startTime=l,void(this._endTime=l);for(0!==n?(e=d-n,f=e/(m-k),l+=e,this._ticks[l]=this._interpolatePoint(i,j,f)):this._ticks[l]=i,this._startTime=l,l+=d;m>l;)f=(l-k)/(m-k),this._ticks[l]=this._interpolatePoint(i,j,f),l+=d;for(var o=1,p=h.length;p>o;o++)for(i=h[o],j=h[o+1],l=k=g[o],m=g[o+1],n=l%d,0!==n&&m?(e=d-n,f=e/(m-k),l+=e,this._ticks[l]=this._interpolatePoint(i,j,f)):this._ticks[l]=i,l+=d;m>l;)f=(l-k)/(m-k),m-k>c.maxInterpolationTime?this._ticks[l]=i:this._ticks[l]=this._interpolatePoint(i,j,f),l+=d;this._endTime=l-d,this._lastTick=this._ticks[this._endTime]},_interpolatePoint:function(a,b,c){try{var d=[b[0]-a[0],b[1]-a[1]],e=[d[0]*c,d[1]*c];return[a[0]+e[0],a[1]+e[1]]}catch(f){console.log("err: cant interpolate a point"),console.log(["start",a]),console.log(["end",b]),console.log(["ratio",c])}},getFirstTick:function(){return this._ticks[this._startTime]},getLastTick:function(){return this._ticks[this._endTime]},getStartTime:function(){return this._startTime},getEndTime:function(){return this._endTime},tick:function(a){return a>this._endTime?(a=this._endTime,this._map.removeLayer(this._marker)):a<this._startTime?(a=this._startTime,this._map.removeLayer(this._marker)):this._marker.addTo(this._map),this._ticks[a]},setMarker:function(b,c){var d=null;if(d=b?this.tick(b):this.getFirstTick()){var e=new a.LatLng(d[1],d[0]);this._marker=new a.Playback.MoveableMarker(e,c,this._geoJSON)}return this._marker},moveMarker:function(a,b){this._marker&&this._marker.move(a,b)},getMarker:function(){return this._marker}}),a.Playback=a.Playback||{},a.Playback.TrackController=a.Class.extend({initialize:function(a,b,c){this.options=c||{},this._map=a,this._tracks=[]},clearTracks:function(){for(;this._tracks.length>0;){var a=this._tracks.pop(),b=a.getMarker();b&&this._map.removeLayer(b)}},addTrack:function(a,b){if(a){var c=a.setMarker(b,this.options);c&&this._tracks.push(a)}},removeTrack:function(a){var a=a;this._tracks.map(function(b,c){b.id==a&&_tracks.splice(c,1)})},isTrack:function(a){return this._tracks.map(function(b,c){return b.id==a?!0:void 0})},tock:function(b,c){for(var d=0,e=this._tracks.length;e>d;d++){var f=this._tracks[d].tick(b),g=new a.LatLng(f[1],f[0]);this._tracks[d].moveMarker(g,c)}},getStartTime:function(){var a=0;if(this._tracks.length>0){a=this._tracks[0].getStartTime();for(var b=1,c=this._tracks.length;c>b;b++){var d=this._tracks[b].getStartTime();a>d&&(a=d)}}return a},getEndTime:function(){var a=0;if(this._tracks.length>0){a=this._tracks[0].getEndTime();for(var b=1,c=this._tracks.length;c>b;b++){var d=this._tracks[b].getEndTime();d>a&&(a=d)}}return a},getTracks:function(){return this._tracks}}),a.Playback=a.Playback||{},a.Playback.Clock=a.Class.extend({initialize:function(b,c,d){this._trackController=b,this._callbacksArry=[],c&&this.addCallback(c),a.setOptions(this,d),this._speed=this.options.speed,this._tickLen=this.options.tickLen,this._cursor=b.getStartTime(),this._transitionTime=this._tickLen/this._speed},_tick:function(a){return a._cursor>a._trackController.getEndTime()?void clearInterval(a._intervalID):(a._trackController.tock(a._cursor,a._transitionTime),a._callbacks(a._cursor),void(a._cursor+=a._tickLen))},_callbacks:function(a){for(var b=this._callbacksArry,c=0,d=b.length;d>c;c++)b[c](a)},addCallback:function(a){this._callbacksArry.push(a)},start:function(){this._intervalID||(this._intervalID=window.setInterval(this._tick,this._transitionTime,this))},stop:function(){this._intervalID&&(clearInterval(this._intervalID),this._intervalID=null)},getSpeed:function(){return this._speed},isPlaying:function(){return this._intervalID?!0:!1},setSpeed:function(a){this._speed=a,this._transitionTime=this._tickLen/a,this._intervalID&&(this.stop(),this.start())},setCursor:function(a){var b=parseInt(a);if(b){var c=b%this._tickLen;0!==c&&(b+=this._tickLen-c),this._cursor=b,this._trackController.tock(this._cursor,0),this._callbacks(this._cursor)}},getTime:function(){return this._cursor},getStartTime:function(){return this._trackController.getStartTime()},getEndTime:function(){return this._trackController.getEndTime()},getTickLen:function(){return this._tickLen}}),a.Playback=a.Playback||{},a.Playback.TracksLayer=a.Class.extend({initialize:function(b,c){var d=c.layer||{};jQuery.isFunction(d)&&(d=d(feature)),d.pointToLayer||(d.pointToLayer=function(b,c){return new a.CircleMarker(c,{radius:5})}),this.layer=new a.GeoJSON(null,d);var e={"GPS Tracks":this.layer};a.control.layers(null,e,{collapsed:!1}).addTo(b)},clearLayer:function(){for(var a in this.layer._layers)this.layer.removeLayer(this.layer._layers[a])},addLayer:function(a){this.layer.addData(a)}}),a.Playback=a.Playback||{},a.Playback.DateControl=a.Control.extend({options:{position:"topleft",dateFormatFn:a.Playback.Util.DateStr,seasonFormatFn:a.Playback.Util.SeasonStr,timeFormatFn:a.Playback.Util.TimeStr,yearFormatFn:a.Playback.Util.YearStr},initialize:function(b,c){a.setOptions(this,c),this.playback=b},onAdd:function(b){this._container=a.DomUtil.create("div","hdat-control-season");var c=this,d=this.playback,e=d.getTime(),f=a.DomUtil.create("div","",this._container);return this._season=a.DomUtil.create("p","",f),this._season.innerHTML=this.options.seasonFormatFn(e)+" "+this.options.yearFormatFn(e),d.addCallback(function(a){c._season.innerHTML=c.options.seasonFormatFn(a)}),this._container}}),a.Playback.PlayControl=a.Control.extend({options:{position:"bottomleft"},initialize:function(a){this.playback=a},onAdd:function(b){function c(){e.isPlaying()?(e.stop(),d._button.classList.toggle("pause")):(e.start(),d._button.classList.toggle("pause"))}this._container=a.DomUtil.create("div","hdat-control-play");var d=this,e=this.playback;e.setSpeed(100);var f=a.DomUtil.create("div","",this._container);this._button=a.DomUtil.create("button","",f);var g=a.DomEvent.stopPropagation;return a.DomEvent.on(this._button,"click",g).on(this._button,"mousedown",g).on(this._button,"dblclick",g).on(this._button,"click",a.DomEvent.preventDefault).on(this._button,"click",c,this),this._container}}),a.Playback.SliderControl=a.Control.extend({options:{position:"bottomright"},initialize:function(a){this.playback=a},onAdd:function(b){function c(a){var b=Number(a.target.value);e.setCursor(b)}this._container=a.DomUtil.create("div","hdat-control-timeline");var d=this,e=this.playback;this._slider=a.DomUtil.create("input","",this._container),this._slider.type="range",this._slider.min=e.getStartTime(),this._slider.max=e.getEndTime(),this._slider.value=e.getTime();var f=a.DomEvent.stopPropagation;return a.DomEvent.on(this._slider,"click",f).on(this._slider,"mousedown",f).on(this._slider,"dblclick",f).on(this._slider,"click",a.DomEvent.preventDefault).on(this._slider,"change",c,this).on(this._slider,"mousemove",c,this),e.addCallback(function(a){d._slider.value=a}),b.on("playback:add_tracks",function(){d._slider.min=e.getStartTime(),d._slider.max=e.getEndTime(),d._slider.value=e.getTime()}),this._container}}),a.Playback=a.Playback||{},a.Playback.DataStream=a.Class.extend({getDataLight:function(){return dataRange},getDataFull:function(a,b){return track},appropriateTracks:function(a,b,c){var d=a.map(function(a,b){return timestamp>a.startTime&&timestamp<a.endTime?a:void 0});return d},addKeepOrRemoveTracks:function(b){var c=[];0!=b.length&&(c=b.map(function(a,b){return this._trackController.isTrack(a.id)?void 0:a})),c.map(function(b,c){var d=getFullData(b.trackID,this.addData);this._trackController.addTrack(new a.Playback.Track(d,this.options),ms)})}}),a.Playback=a.Playback.Clock.extend({statics:{MoveableMarker:a.Playback.MoveableMarker,Track:a.Playback.Track,TrackController:a.Playback.TrackController,Clock:a.Playback.Clock,Util:a.Playback.Util,TracksLayer:a.Playback.TracksLayer,PlayControl:a.Playback.PlayControl,DateControl:a.Playback.DateControl,SliderControl:a.Playback.SliderControl},options:{tickLen:250,speed:1,maxInterpolationTime:3e5,tracksLayer:!0,playControl:!1,dateControl:!1,sliderControl:!1,layer:{},marker:{}},initialize:function(b,c,d,e){a.setOptions(this,e),this._map=b,this._trackController=new a.Playback.TrackController(b,null,this.options),a.Playback.Clock.prototype.initialize.call(this,this._trackController,d,this.options),this.options.tracksLayer&&(this._tracksLayer=new a.Playback.TracksLayer(b,e)),this.setData(b,c),this.options.playControl&&(this.playControl=new a.Playback.PlayControl(this),this.playControl.addTo(b)),this.options.sliderControl&&(this.sliderControl=new a.Playback.SliderControl(this),this.sliderControl.addTo(b)),this.options.dateControl&&(this.dateControl=new a.Playback.DateControl(this,e),this.dateControl.addTo(b))},clearData:function(){this._trackController.clearTracks(),this._tracksLayer&&this._tracksLayer.clearLayer()},setData:function(a,b){this.clearData(),this.addData(a,b,this.getTime()),this.setCursor(this.getStartTime())},addData:function(b,c,d){if(c){if(c instanceof Array)for(var e=0,f=c.length;f>e;e++)this._trackController.addTrack(new a.Playback.Track(b,c[e],this.options),d);else this._trackController.addTrack(new a.Playback.Track(b,c,this.options),d);this.options.tracksLayer&&this._tracksLayer.addLayer(c)}},addDataStream:function(){this.dataStream=new a.Playback.DataStream(this)},destroy:function(){this.clearData(),this.playControl&&this._map.removeControl(this.playControl),this.sliderControl&&this._map.removeControl(this.sliderControl),this.dateControl&&this._map.removeControl(this.dateControl)}}),a.playback=function(b,c,d,e){return new a.Playback(b,c,d,e)},a.Playback});